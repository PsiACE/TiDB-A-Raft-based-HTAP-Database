# 简介

关系数据库管理系统（RDBMS）因其关系模型，强大的事务保证和 SQL 接口而大受欢迎。RDBMS 被商业系统这样的传统应用广泛采纳,但是，它并不提供可扩展性和高可用性。因此，在 21 世纪初 [11] ，互联网应用程序更偏向于使用 NoSQL 系统，例如 Google Bigtable [12] 和 DynamoDB [36] 。NoSQL 系统放宽了一致性要求，同时提供更高的可扩展性和用于替代的数据模型，例如键值对、图和文档。然而，许多应用仍然需要事务处理能力、数据一致性和 SQL 接口，因此出现了 NewSQL 系统。诸如 CockroachDB [38] 和 Google Spanner [14] 之类的 NewSQL 系统为在线事务处理（OLTP）读 / 写工作负载提供 NoSQL 般的高可扩展性，同时也为事物处理提供 ACID 保证。此外，像许多架构在 Hadoop 之上的 SQL 系统一样，基于 SQL 的在线分析处理（OLAP）系统正在迅速发展 [16] 。

这些系统认为 “不存在万应良方”（one size does not fit all）[37] ，故而针对 OLAP 和 OLTP 的不同目标采用不同的数据模型和技术方案。然而，同时开发、部署并维护多个业务系统的成本非常高。除此之外，对最新的数据进行实时分析是一件非常诱人的事情。故而工业界和学术界开始探索 OLTP 和 OLAP 混合系统（HTAP）的可行性 [30] 。HTAP 系统应像 NewSQL 系统一样实现可扩展性，高可用性和强一致性。此外，HTAP 系统还要能高效地读取最新数据，以确保 OLTP 和 OLAP 系统的高并发和低延迟访问，并满足数据实时更新和隔离。

数据实时更新（Freshness），是指分析查询处理最新的数据的方式 [34] 。实时分析最新数据具有巨大的业务价值。但是在某些 HTAP 解决方案中，例如基于提取-转换-加载（ETL）的解决方案中，不能保证分析的实时性。通过 ETL 过程，OLTP 系统会定期将最新的一批数据推送到 OLAP 系统中。ETL 往往需要花费数小时或数天的时间，因此无法提供实时的数据分析。可以将最新数据通过数据流方式传输到 OLAP 系统来替换 ETL 过程，以减少同步时间。但是，由于这两种方法都缺少全局数据治理模型，因此一致性语义会更加复杂。而且与多个系统接口进行交互会带来额外的开销。

隔离（Isolation），是指为单独的 OLTP 和 OLAP 查询保证不受影响的性能。一些内存数据库（例如 HyPer [18]）使分析查询能够从同一服务器上的事务处理中读取最新版本的数据。 尽管这种方法提供了新鲜的数据，但它不能使 OLTP 和 OLAP 同时达到高性能。这是由于数据同步损失和工作负载干扰。一项研究 [34] 通过分别为 HyPer 和 SAP HANA 运行 HTAP 基准测试 CH-benCHmark [13] 调查了这种影响。该研究发现，当系统在进行事务处理的同时运行分析查询时，其可达到的最大 OLTP 吞吐量将显著降低。SAP HANA [22] 的吞吐量至少降低了三倍，HyPer 至少降低了五倍。这一结论同样在 MemSQL 上得到了证实 [24] 。 此外，如果内存数据库仅部署在单个服务器上，则无法提供高可用性和可扩展性。

为了保证隔离性能，有必要在不同的硬件资源上处理 OLTP 和 OLAP 请求。最主要的困难是在单一系统中为 OLAP 请求提供最新的 OLTP 数据副本。此外，系统需要在多个数据副本间保持一致性。注意，高可用性也需要保持一致的副本 [29] 。使用众所周知的共识算法，例如 Paxos [20] 和 Raft [29] ，可以实现高可用性。它们基于复制状态机来同步副本。可以扩展这些共识算法，从而为 HTAP 工作负载提供一致的副本。据研究所知，这个想法以前没有被研究过。

遵循这个想法，本研究提出了一个基于 Raft 共识算法的 HTAP 数据库：TiDB 。向 Raft 共识算法引入了专用的学习者节点 Learner 。Learner 将会异步地复制领导者节点 Leader 的事务日志，并为 OLAP 查询构造新的副本。特别是，Learner 将日志中的行格式元组转换为列格式，从而使副本更适合于分析查询。这种日志复制只会对 Leader 上运行的事务查询造成少量开销。而且，复制的时间很短，甚至可以保证 OLAP 始终访问到最新数据。不仅通过使用不同的数据副本来分别处理 OLAP 和 OLTP 请求，以避免它们之间的干扰。还可以基于行格式和列格式的数据副本来优化 HTAP 请求。基于 Raft 协议，TiDB 提供了高可用性，可扩展性和数据一致性保证。

TiDB 展现了一种创新的解决方案，可以帮助基于共识算法的 NewSQL 系统发展成为 HTAP 系统。NewSQL 系统通过复制其的数据库（如 Google Spanner 和 CockroachDB）确保 OLTP 请求的高可用性、可扩展性和数据持久性。通过复制机制（通常来自共识算法）在数据副本之间同步数据。基于日志复制，NewSQL 系统可以提供一个专用于 OLAP 请求的列式副本，这样就可以像 TiDB 一样独立支持 HTAP 请求。

本研究的贡献总结如下：

- 本研究提出并建立基于共识算法的 HTAP 系统，实现基于 Raft 的 HTAP 数据库 —— TiDB 。这是一个开源项目 [7] ，为 HTAP 工作负载提供高可用性、一致性、可扩展性、数据实时更新和隔离。
- 本研究为 Raft 算法引入学习者角色 Learner ，为实时 OLAP 查询生成列式存储。
- 本研究实现了 multi-Raft 系统，并对其读写性能进行优化，使系统在扩展到更多节点时能够具有高性能。
- 本研究为大规模 HTAP 查询定制 SQL 引擎。引擎可以最优选择使用行式存储和列式存储。
- 本研究使用 HTAP 基准测试 CH-benCHmark 对 TiDB 的 OLTP、OLAP 和 HTAP 性能进行了全面的实验评估。

本文的其余部分组织如下。第 2 节中描述了基于 Raft 共识算法的 HTAP 存储系统的主要思想，并在第 3 节中描述 TiDB 体系结构。第 4 节和第 5 节详细介绍 TiDB 的多层存储和 HTAP 引擎。实验评估见第 6 节。第 7 节总结相关工作。最后，第 8 节中对论文进行总结。
